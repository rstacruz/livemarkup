!function(lm){if(typeof module==="object")module.exports=lm;else this.LM=lm}(function($){var LM={};var templates={};LM.tagSettings={tag:/\{\{([\s\S]+?)(?:\s+->\s+([\s\S]+?))?\}\}/g};LM.register=function(name,code){templates[name]=code};LM.get=function(name,element){if(!(name in templates))throw new Error("No such template: "+name);var code=templates[name];var view;if(element.el){view=element;element=view.el}var html=$(element).html(code);var tpl=new Template(html);if(view)tpl.locals({view:view});return tpl};function Template($el){this.$el=$el;this.model=null;this.localContext={};this.tags=[];this._initialized=false}Template.prototype.bind=function(object){this.model=object;return this};Template.prototype.render=function(){this.initialize();_.each(this.tags,function(tag){tag.render()});return this};Template.prototype.initialize=function(){if(this._initialized)return;this.tags=LM.fetchTags(this.$el,this);_.each(this.tags,function(tag){tag.parse()});this._initialized=true;return this};Template.prototype.locals=function(obj){if(typeof obj==="object"){_.extend(this.localContext,obj)}else if(arguments.length===2){this.localContext[arguments[0]]=arguments[1]}return this};LM.fetchTags=function($el,template){var tags=[];var regex=LM.tagSettings.tag;$el.find("*").andSelf().each(function(i){var parent=this;eachTextNode(this,function(node,text){parent.removeChild(node);var matches=text.split(regex);var directive;_.each(matches,function(match,i){var type=["text","directives","code"][i%3];if(type==="text"){appendText(parent,match)}else if(type==="directives"){directive=match}else{var node=appendText(parent,"");var tag=new Tag(node,directive,match,template);tags.push(tag)}})})});return tags};function Tag(node,src,formatter,template){this.node=node;this.src=src;this.formatters=[new Function("return "+formatter)];this.template=template;this.getters=[];this.dsl=new TagContext(this);this.onrender=null}Tag.prototype.getValue=function(){var re;var context=this.node.model;_.each(this.formatters,function(fn){re=fn.call(context,re)});return re};Tag.prototype.parse=function(){var fn=new Function("dsl","dsl."+this.src);fn.apply(this,[this.dsl])};Tag.prototype.render=function(){if(this.onrender)this.onrender()};Tag.prototype.addFormatter=function(fn){};function TagContext(tag){this.tag=tag;this.template=this.tag.template}LM.directives=TagContext.prototype;LM.directives.html=function(){var tag=this.tag;tag.parent=$(tag.node).parent();tag.onrender=function(){tag.parent.html(tag.getValue())};return this};LM.directives.text=function(){var tag=this.tag;tag.onrender=function(){tag.node.nodeValue=tag.getValue()};return this};LM.directives.on=function(model,event){if(!event){event=model;model=null}var tag=this.tag;var template=this.template;if(!model)model=template.model;if(!model)return;model.on(event,function(){tag.render()});return this};LM.directives.attr=function(model,attr){if(!event){attr=model;model=null}var tag=this.tag;var template=this.template;if(!model)model=template.model;this.on(model,"change:"+attr);tag.addFormatter(function(){model.get(attr)});return this};return LM;function eachTextNode(node,block){$(node).contents().each(function(){if(this.nodeType!==3)return;block(this,this.nodeValue)})}function appendText(parent,text){var node=document.createTextNode(text);parent.appendChild(node);return node}}(jQuery||Zepto||ender));